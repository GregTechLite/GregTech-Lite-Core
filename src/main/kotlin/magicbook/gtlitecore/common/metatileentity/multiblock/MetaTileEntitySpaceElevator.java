package magicbook.gtlitecore.common.metatileentity.multiblock;

import codechicken.lib.render.CCRenderState;
import codechicken.lib.render.pipeline.IVertexOperation;
import codechicken.lib.vec.Matrix4;
import gregtech.api.capability.IControllable;
import gregtech.api.capability.IEnergyContainer;
import gregtech.api.capability.IOpticalComputationHatch;
import gregtech.api.capability.IOpticalComputationProvider;
import gregtech.api.capability.impl.EnergyContainerList;
import gregtech.api.gui.ModularUI;
import gregtech.api.gui.Widget;
import gregtech.api.gui.widgets.ImageCycleButtonWidget;
import gregtech.api.metatileentity.MetaTileEntity;
import gregtech.api.metatileentity.interfaces.IGregTechTileEntity;
import gregtech.api.metatileentity.multiblock.IMultiblockPart;
import gregtech.api.metatileentity.multiblock.MultiblockAbility;
import gregtech.api.metatileentity.multiblock.MultiblockWithDisplayBase;
import gregtech.api.pattern.BlockPattern;
import gregtech.api.pattern.FactoryBlockPattern;
import gregtech.api.pattern.PatternMatchContext;
import gregtech.api.pattern.TraceabilityPredicate;
import gregtech.client.renderer.ICubeRenderer;
import lombok.Getter;
import magicbook.gtlitecore.api.block.impl.WrappedIntTier;
import magicbook.gtlitecore.api.capability.IModuleProvider;
import magicbook.gtlitecore.api.capability.IModuleReceiver;
import magicbook.gtlitecore.api.gui.GTLiteGuiTextures;
import magicbook.gtlitecore.client.renderer.texture.GTLiteTextures;
import magicbook.gtlitecore.common.block.GTLiteMetaBlocks;
import magicbook.gtlitecore.common.block.blocks.BlockSpaceElevatorCasing;
import net.minecraft.block.Block;
import net.minecraft.block.state.IBlockState;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.nbt.NBTTagCompound;
import net.minecraft.network.PacketBuffer;
import net.minecraft.tileentity.TileEntity;
import net.minecraft.util.ResourceLocation;
import net.minecraftforge.fml.relauncher.Side;
import net.minecraftforge.fml.relauncher.SideOnly;
import org.jetbrains.annotations.ApiStatus;
import org.jetbrains.annotations.NotNull;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.concurrent.ConcurrentHashMap;

import static gregtech.api.unification.material.Materials.Neutronium;
import static gregtech.api.util.RelativeDirection.DOWN;
import static gregtech.api.util.RelativeDirection.FRONT;
import static gregtech.api.util.RelativeDirection.RIGHT;
import static magicbook.gtlitecore.api.utils.GTLiteUtility.getOrDefault;
import static magicbook.gtlitecore.api.utils.StructureUtility.accelerationOrbits;
import static magicbook.gtlitecore.integration.groovyscript.hooks.GrSRecipeHooks.SECOND;

public class MetaTileEntitySpaceElevator extends MultiblockWithDisplayBase implements IModuleProvider
{

    protected IEnergyContainer energyContainer;
    @Getter
    protected IOpticalComputationProvider computationProvider;

    protected int orbitTier;

    private boolean isExtended = false;

    private final Collection<IModuleReceiver> moduleReceivers = ConcurrentHashMap.newKeySet();

    public MetaTileEntitySpaceElevator(ResourceLocation metaTileEntityId)
    {
        super(metaTileEntityId);
    }

    @Override
    public MetaTileEntity createMetaTileEntity(IGregTechTileEntity tileEntity)
    {
        return new MetaTileEntitySpaceElevator(metaTileEntityId);
    }

    @Override
    public void update()
    {
        super.update();
        if (!isStructureFormed())
            moduleReceivers.forEach(IModuleReceiver::sentWorkingDisabled);
    }

    @Override
    protected void updateFormedValid()
    {
        if (!moduleReceivers.isEmpty())
        {
            if (!checkModules())
                invalidateStructure();
        }
        if (getOffsetTimer() % SECOND == 0)
        {
            moduleReceivers.removeIf(receiver -> receiver.getModuleProvider() == null);
        }
    }

    @Override
    protected void formStructure(PatternMatchContext context)
    {
        super.formStructure(context);
        initializeAbilities();
        Object type = context.get("AccelerationOrbitTieredStats");
        orbitTier = getOrDefault(
                () -> type instanceof WrappedIntTier,
                () -> ((WrappedIntTier) type).getIntTier(), 0);
    }

    @Override
    public void invalidateStructure()
    {
        super.invalidateStructure();
        resetTileAbilities();
        orbitTier = 0;
        moduleReceivers.forEach(IModuleReceiver::sentWorkingDisabled);
        moduleReceivers.forEach(receiver -> receiver.setModuleProvider(null));
    }

    @Override
    public void checkStructurePattern()
    {
        super.checkStructurePattern();
        if (getOffsetTimer() % (5 * SECOND) == 0 || isFirstTick())
        {
            if (!isStructureFormed())
                reinitializeStructurePattern();
            super.checkStructurePattern();
        }
    }

    protected void initializeAbilities()
    {
        List<IEnergyContainer> inputEnergy = new ArrayList<>(getAbilities(MultiblockAbility.INPUT_ENERGY));
        inputEnergy.addAll(getAbilities(MultiblockAbility.SUBSTATION_INPUT_ENERGY));
        inputEnergy.addAll(getAbilities(MultiblockAbility.INPUT_LASER));
        energyContainer = new EnergyContainerList(inputEnergy);

        List<IOpticalComputationHatch> inputComputation = getAbilities(MultiblockAbility.COMPUTATION_DATA_RECEPTION);
        if (inputComputation != null && !inputComputation.isEmpty())
            computationProvider = inputComputation.get(0);
    }

    protected void resetTileAbilities()
    {
        energyContainer = new EnergyContainerList(new ArrayList<>());
    }

    @NotNull
    @Override
    protected BlockPattern createStructurePattern()
    {
        if (!isExtended)
        {
            return FactoryBlockPattern.start(RIGHT, DOWN, FRONT)
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "               FF FF               ", "               AAAAA               ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "               D   D               ", "            FFFFF FFFFF            ", "            AAAAAAAAAAA            ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "            DDDDE EDDDD            ", "          FFFFFFF FFFFFFF          ", "          AAAAAAAAAAAAAAA          ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "          DD   DE ED   DD          ", "         FFFFFFD   DFFFFFF         ", "        AAAAAAAAAAAAAAAAAAA        ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               D   D               ", "         FFF           FFF         ", "       AAAAAAAAAAAAAAAAAAAAA       ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               DE ED               ", "                                   ", "                                   ", "      AAAAAAAAAAAAAAAAAAAAAAA      ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "                                   ", "                                   ", "                                   ", "     AAAAAAAAAAAAAAAAAAAAAAAAA     ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "              HDE EDH              ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "    AAAAAAAAAAAAAAAAAAAAAAAAAAA    ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "            HH DE ED HH            ", "                                   ", "                                   ", "                                   ", "                                   ", "               V V V               ", "               V V V               ", "               V V V               ", "               V V V               ", "   AAAAAAAAAAAAV V VAAAAAAAAAAAA   ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "                                   ", "         E               E         ", "         EHH           HHE         ", "         E               E         ", "         E               E         ", "         E               E         ", "         E               E         ", "         E     V V V     E         ", "         E     I I I     E         ", "         E     V V V     E         ", "   FF    E     V V V     E    FF   ", "   AAAAAAAAAAAAV V VAAAAAAAAAAAA   ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "          E             E          ", "          E             E          ", "          E             E          ", "          E             E          ", "          E             E          ", "         HE             EH         ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "   D                           D   ", "  FFF          F F F          FFF  ", "  AAAAAAAAAAAAA     AAAAAAAAAAAAA  ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "                                   ", "                                   ", "           E           E           ", "           E           E           ", "           E           E           ", "           E           E           ", "           E           E           ", "                                   ", "                                   ", "         H               H         ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "   D                           D   ", "  FFF          F F F          FFF  ", "  AAAAAAAAAAAAA     AAAAAAAAAAAAA  ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "             HH     HH             ", "            E         E            ", "            E         E            ", "            E         E            ", "            E         E            ", "            E         E            ", "            E         E            ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "        H                 H        ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "  D                             D  ", " FFF          FFFFFFF          FFF ", " AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                FFF                ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "             E       E             ", "             E       E             ", "             E       E             ", "             E       E             ", "             E       E             ", "             E       E             ", "             E       E             ", "            HE       EH            ", "             E       E             ", "             E       E             ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "        H                 H        ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "  D                             D  ", " FFF         FFFFFFFFF         FFF ", " AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA ")
                    .aisle("                FFF                ", "                 E                 ", "                 E                 ", "                 E                 ", "                 E                 ", "                 E                 ", "               F   F               ", "              E     E              ", "              E     E              ", "              E     E              ", "              E     E              ", "              E     E              ", "              E     E              ", "              E     E              ", "              E     E              ", "              E     E              ", "                                   ", "                                   ", "                FFF                ", "                                   ", "                                   ", "            H         H            ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                FFF                ", "                                   ", "                                   ", "                                   ", "                                   ", "       H                   H       ", "                                   ", "                                   ", "                                   ", "                                   ", "                XXX                ", "                X~X                ", "  D             XXX             D  ", " FFF        FFFFFFFFFFF        FFF ", " AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA ")
                    .aisle("               F D F               ", "                 D                 ", "                 D                 ", "                 D                 ", "                 D                 ", "                 D                 ", "              F  D  F              ", "                 D                 ", "            D    D    D            ", "            D    D    D            ", "            D    D    D            ", "            D    D    D            ", "            D    D    D            ", "            D    D    D            ", "            D    D    D            ", "           DD    D    DD           ", "           D     D     D           ", "           D     D     D           ", "           D   F D F   D           ", "           D     C     D           ", "           D     C     D           ", "           D     C     D           ", "           D     C     D           ", "          DD     C     DD          ", "          D      C      D          ", "          D      C      D          ", "          D      C      D          ", "         DD      C      DD         ", "         D     FDCDF     D         ", "         D      DCD      D         ", "        DD      DCD      DD        ", "        D       DCD       D        ", "        D       DCD       D        ", "       DD      DDCDD      DD       ", "       D       D C D       D       ", "       D       D C D       D       ", "      DD       D C D       DD      ", "      D        D C D        D      ", "     DD VV     XDCDX     VV DD     ", "    DD  VI     XDCDX     IV  DD    ", " DDDD   VV     XDCDX     VV   DDDD ", "FFFD    VVFFFFFDDDDDFFFFFVV    DFFF", "AAAAAAAAVV  AAAXXXXXAAA  VVAAAAAAAA")
                    .aisle("              F     F              ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "             F       F             ", "            E         E            ", "            E         E            ", "            E         E            ", "            E         E            ", "            E         E            ", "            E         E            ", "            E         E            ", "           EE         EE           ", "           EE         EE           ", "           E           E           ", "           E           E           ", "           E  F     F  E           ", "           E           E           ", "           E           E           ", "           E           E           ", "          EE           EE          ", "          EE           EE          ", "          E             E          ", "          E             E          ", "         EE             EE         ", "         EE             EE         ", "         E    FD   DF    E         ", "        EE     D   D     EE        ", "        EE     D   D     EE        ", "        E      D   D      E        ", "       EE      D   D      EE       ", "       EE      D   D      EE       ", "       E                   E       ", "      EE                   EE      ", "      EE                   EE      ", "     EE                     EE     ", "    EEE       XD   DX       EEE    ", "   EEE        XD   DX        EEE   ", "  EE          XD   DX          EE  ", "FFF         FFFDDDDDFFF         FFF", "AAAAAAAA    AAAXXXXXAAA    AAAAAAAA")
                    .aisle("              FD   DF              ", "              ED   DE              ", "              ED   DE              ", "              ED   DE              ", "              ED   DE              ", "              ED   DE              ", "             F D   D F             ", "               D   D               ", "               D   D               ", "               D   D               ", "               D   D               ", "               D   D               ", "               D   D               ", "               D   D               ", "               D   D               ", "               D   D               ", "               D   D               ", "               D B D               ", "              FD - DF              ", "               C - C               ", "               C - C               ", "               C - C               ", "               C - C               ", "               C - C               ", "               C - C               ", "               C - C               ", "               C - C               ", "               C - C               ", "              FC - CF              ", "               C - C               ", "               C - C               ", "               C - C               ", "               C - C               ", "               C - C               ", "               C - C               ", "               C - C               ", "               C - C               ", "               C - C               ", "        VV    XC - CX    VV        ", "        VI    XC - CX    IV        ", "        VV    XC - CX    VV        ", "        VVFFFFFDDDDDFFFFFVV        ", "AAAAAAAAVV  AAAXXXXXAAA  VVAAAAAAAA")
                    .aisle("              F     F              ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "             F       F             ", "            E         E            ", "            E         E            ", "            E         E            ", "            E         E            ", "            E         E            ", "            E         E            ", "            E         E            ", "           EE         EE           ", "           EE         EE           ", "           E           E           ", "           E           E           ", "           E  F     F  E           ", "           E           E           ", "           E           E           ", "           E           E           ", "          EE           EE          ", "          EE           EE          ", "          E             E          ", "          E             E          ", "         EE             EE         ", "         EE             EE         ", "         E    FD   DF    E         ", "        EE     D   D     EE        ", "        EE     D   D     EE        ", "        E      D   D      E        ", "       EE      D   D      EE       ", "       EE      D   D      EE       ", "       E                   E       ", "      EE                   EE      ", "      EE                   EE      ", "     EE                     EE     ", "    EEE       XD   DX       EEE    ", "   EEE        XD   DX        EEE   ", "  EE          XD   DX          EE  ", "FFF         FFFDDDDDFFF         FFF", "AAAAAAAA    AAAXXXXXAAA    AAAAAAAA")
                    .aisle("               F D F               ", "                 D                 ", "                 D                 ", "                 D                 ", "                 D                 ", "                 D                 ", "              F  D  F              ", "                 D                 ", "            D    D    D            ", "            D    D    D            ", "            D    D    D            ", "            D    D    D            ", "            D    D    D            ", "            D    D    D            ", "            D    D    D            ", "           DD    D    DD           ", "           D     D     D           ", "           D     D     D           ", "           D   F D F   D           ", "           D     C     D           ", "           D     C     D           ", "           D     C     D           ", "           D     C     D           ", "          DD     C     DD          ", "          D      C      D          ", "          D      C      D          ", "          D      C      D          ", "         DD      C      DD         ", "         D     FDCDF     D         ", "         D      DCD      D         ", "        DD      DCD      DD        ", "        D       DCD       D        ", "        D       DCD       D        ", "       DD      DDCDD      DD       ", "       D       D C D       D       ", "       D       D C D       D       ", "      DD       D C D       DD      ", "      D        D C D        D      ", "     DD VV     XDCDX     VV DD     ", "    DD  VI     XDCDX     IV  DD    ", " DDDD   VV     XDCDX     VV   DDDD ", "FFFD    VVFFFFFDDDDDFFFFFVV    DFFF", "AAAAAAAAVV  AAAXXXXXAAA  VVAAAAAAAA")
                    .aisle("                FFF                ", "                 E                 ", "                 E                 ", "                 E                 ", "                 E                 ", "                 E                 ", "               F   F               ", "              E     E              ", "              E     E              ", "              E     E              ", "              E     E              ", "              E     E              ", "              E     E              ", "              E     E              ", "              E     E              ", "              E     E              ", "                                   ", "                                   ", "                FFF                ", "                                   ", "                                   ", "            H         H            ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                FFF                ", "                                   ", "                                   ", "                                   ", "                                   ", "       H                   H       ", "                                   ", "                                   ", "                                   ", "                                   ", "                XXX                ", "                XXX                ", "  D             XXX             D  ", " FFF        FFFFFFFFFFF        FFF ", " AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                FFF                ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "             E       E             ", "             E       E             ", "             E       E             ", "             E       E             ", "             E       E             ", "             E       E             ", "             E       E             ", "            HE       EH            ", "             E       E             ", "             E       E             ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "        H                 H        ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "  D                             D  ", " FFF         FFFFFFFFF         FFF ", " AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "             HH     HH             ", "            E         E            ", "            E         E            ", "            E         E            ", "            E         E            ", "            E         E            ", "            E         E            ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "        H                 H        ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "  D                             D  ", " FFF          FFFFFFF          FFF ", " AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "                                   ", "                                   ", "           E           E           ", "           E           E           ", "           E           E           ", "           E           E           ", "           E           E           ", "                                   ", "                                   ", "         H               H         ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "   D                           D   ", "  FFF          F F F          FFF  ", "  AAAAAAAAAAAAA     AAAAAAAAAAAAA  ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "          E             E          ", "          E             E          ", "          E             E          ", "          E             E          ", "          E             E          ", "         HE             EH         ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "   D                           D   ", "  FFF          F F F          FFF  ", "  AAAAAAAAAAAAA     AAAAAAAAAAAAA  ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "                                   ", "         E               E         ", "         EHH           HHE         ", "         E               E         ", "         E               E         ", "         E               E         ", "         E               E         ", "         E     V V V     E         ", "         E     I I I     E         ", "         E     V V V     E         ", "   FF    E     V V V     E    FF   ", "   AAAAAAAAAAAAV V VAAAAAAAAAAAA   ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "            HH DE ED HH            ", "                                   ", "                                   ", "                                   ", "                                   ", "               V V V               ", "               V V V               ", "               V V V               ", "               V V V               ", "   AAAAAAAAAAAAV V VAAAAAAAAAAAA   ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "              HDE EDH              ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "    AAAAAAAAAAAAAAAAAAAAAAAAAAA    ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               DE ED               ", "               DE ED               ", "                                   ", "                                   ", "                                   ", "     AAAAAAAAAAAAAAAAAAAAAAAAA     ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               DE ED               ", "                                   ", "                                   ", "      AAAAAAAAAAAAAAAAAAAAAAA      ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "               DE ED               ", "               D   D               ", "         FFF           FFF         ", "       AAAAAAAAAAAAAAAAAAAAA       ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                E E                ", "          DD   DE ED   DD          ", "         FFFFFFD   DFFFFFF         ", "        AAAAAAAAAAAAAAAAAAA        ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "            DDDDE EDDDD            ", "          FFFFFFF FFFFFFF          ", "          AAAAAAAAAAAAAAA          ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "               D   D               ", "            FFFFF FFFFF            ", "            AAAAAAAAAAA            ")
                    .aisle("                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "                                   ", "               FF FF               ", "               AAAAA               ")
                    .where('~', selfPredicate())
                    .where('D', states(getCasingState()))
                    .where('F', states(getSecondCasingState()))
                    .where('E', states(getThirdCasingState()))
                    .where('A', states(getFourthCasingState()))
                    .where('H', frames(Neutronium))
                    .where('X', states(getCasingState())
                            .or(abilities(MultiblockAbility.INPUT_ENERGY)
                                    .setMaxGlobalLimited(2)
                                    .setPreviewCount(1))
                            .or(abilities(MultiblockAbility.INPUT_LASER)
                                    .setMaxGlobalLimited(1)
                                    .setPreviewCount(0))
                            .or(abilities(MultiblockAbility.COMPUTATION_DATA_RECEPTION)
                                    .setMaxGlobalLimited(1)
                                    .setPreviewCount(1)))
                    .where('V', states(getCasingState())
                            .or(abilities(MultiblockAbility.IMPORT_ITEMS, MultiblockAbility.IMPORT_FLUIDS,
                                    MultiblockAbility.EXPORT_ITEMS, MultiblockAbility.EXPORT_FLUIDS,
                                    MultiblockAbility.COMPUTATION_DATA_RECEPTION)
                                    .setPreviewCount(0)))
                    .where('C', accelerationOrbits())
                    .where('I', states(getCasingState())
                            .or(modulePredicate()))
                    .where(' ', any())
                    .where('-', air())
                    .where('B', air()) // TODO A renderer block (space elevator cable)?
                    .build();
        }
        else
        {
            return FactoryBlockPattern.start(RIGHT, DOWN, FRONT)
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                    FFFFFFF                    ","                    AAAAAAA                    ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                     V V V                     ","                     V V V                     ","                     V V V                     ","                   FFV V VFF                   ","                 AAAAV V VAAAA                 ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                     V V V                     ","                     I I I                     ","                     V V V                     ","                   FFV V VFF                   ","              AAAAAAAV V VAAAAAAA              ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                   FFF F FFF                   ","            AAAAAAAAAA   AAAAAAAAAA            ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                  FFFF F FFFF                  ","          AAAA   AAAAA   AAAAA   AAAA          ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                  FFFF F FFFF                  ","        AAAA     AAAAA   AAAAA     AAAA        ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                  FFFFFFFFFFF                  ","       AAA      AAAAAAAAAAAAAAA      AAA       ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                     D   D                     ","                  FFFFF FFFFF                  ","      AAA       AAAAAAAAAAAAAAA       AAA      ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                  DDDDE EDDDD                  ","                FFFFFFF FFFFFFF                ","     AAA        AAAAAAAAAAAAAAA        AAA     ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                DD   DE ED   DD                ","               FFFFFFD   DFFFFFF               ","     AA       AAAAAAAAAAAAAAAAAAA       AA     ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     D   D                     ","               FFF           FFF               ","    AA       AAAAAAAAAAAAAAAAAAAAA       AA    ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     DE ED                     ","                                               ","                                               ","    AA      AAAAAAAAAAAAAAAAAAAAAAA      AA    ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                                               ","                                               ","                                               ","   AA      AAAAAAAAAAAAAAAAAAAAAAAAA      AA   ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                    HDE EDH                    ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                                               ","                                               ","                                               ","                                               ","                                               ","   AA     AAAAAAAAAAAAAAAAAAAAAAAAAAA     AA   ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                  HH DE ED HH                  ","                                               ","                                               ","                                               ","                                               ","                     V V V                     ","                     V V V                     ","                     V V V                     ","                     V V V                     ","  AA     AAAAAAAAAAAAV V VAAAAAAAAAAAA     AA  ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                                               ","               E               E               ","               EHH           HHE               ","               E               E               ","               E               E               ","               E               E               ","               E               E               ","               E     V V V     E               ","               E     I I I     E               ","               E     V V V     E               ","         FF    E     V V V     E    FF         ","  AA     AAAAAAAAAAAAV V VAAAAAAAAAAAA     AA  ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                E             E                ","                E             E                ","                E             E                ","                E             E                ","                E             E                ","               HE             EH               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","         D                           D         ","        FFF          F F F          FFF        ","  AA  AAAAAAAAAAAAAAA     AAAAAAAAAAAAAAA  AA  ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                                               ","                                               ","                 E           E                 ","                 E           E                 ","                 E           E                 ","                 E           E                 ","                 E           E                 ","                                               ","                                               ","               H               H               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","         D                           D         ","        FFF          F F F          FFF        "," AAAAAAAAAAAAAAAAAAAA     AAAAAAAAAAAAAAAAAAAA ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                                               ","                                               ","                                               ","                                               ","                                               ","                   HH     HH                   ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                                               ","                                               ","                                               ","                                               ","                                               ","              H                 H              ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","        D                             D        ","    FFFFFF          FFFFFFF          FFFFFF    "," AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      FFF                      ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                   E       E                   ","                   E       E                   ","                   E       E                   ","                   E       E                   ","                   E       E                   ","                   E       E                   ","                   E       E                   ","                  HE       EH                  ","                   E       E                   ","                   E       E                   ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","              H                 H              ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","        D                             D        "," FFFFFFFFF         FFFFFFFFF         FFFFFFFFF "," AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA ")
                    .aisle("                      FFF                      ","                       E                       ","                       E                       ","                       E                       ","                       E                       ","                       E                       ","                     F   F                     ","                    E     E                    ","                    E     E                    ","                    E     E                    ","                    E     E                    ","                    E     E                    ","                    E     E                    ","                    E     E                    ","                    E     E                    ","                    E     E                    ","                                               ","                                               ","                      FFF                      ","                                               ","                                               ","                  H         H                  ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      FFF                      ","                                               ","                                               ","                                               ","                                               ","             H                   H             ","                                               ","                                               ","                                               ","                                               ","                      XXX                      ","                      X~X                      ","        D             XXX             D        ","FFFFFFFFFF        FFFFFFFFFFF        FFFFFFFFFF","AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA")
                    .aisle("                     F D F                     ","                       D                       ","                       D                       ","                       D                       ","                       D                       ","                       D                       ","                    F  D  F                    ","                       D                       ","                  D    D    D                  ","                  D    D    D                  ","                  D    D    D                  ","                  D    D    D                  ","                  D    D    D                  ","                  D    D    D                  ","                  D    D    D                  ","                 DD    D    DD                 ","                 D     D     D                 ","                 D     D     D                 ","                 D   F D F   D                 ","                 D     C     D                 ","                 D     C     D                 ","                 D     C     D                 ","                 D     C     D                 ","                DD     C     DD                ","                D      C      D                ","                D      C      D                ","                D      C      D                ","               DD      C      DD               ","               D     FDCDF     D               ","               D      DCD      D               ","              DD      DCD      DD              ","              D       DCD       D              ","              D       DCD       D              ","             DD      DDCDD      DD             ","             D       D C D       D             ","             D       D C D       D             ","            DD       D C D       DD            ","            D        D C D        D            "," VV        DD VV     XDCDX     VV DD        VV "," VI       DD  VI     XDCDX     IV  DD       IV "," VV    DDDD   VV     XDCDX     VV   DDDD    VV ","FVVFFFFFFD    VVFFFFFDDDDDFFFFFVV    DFFFFFFVVF","AVVAAAAAAAAAAAVV  AAAXXXXXAAA  VVAAAAAAAAAAAVVA")
                    .aisle("                    F     F                    ","                                               ","                                               ","                                               ","                                               ","                                               ","                   F       F                   ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                 EE         EE                 ","                 EE         EE                 ","                 E           E                 ","                 E           E                 ","                 E  F     F  E                 ","                 E           E                 ","                 E           E                 ","                 E           E                 ","                EE           EE                ","                EE           EE                ","                E             E                ","                E             E                ","               EE             EE               ","               EE             EE               ","               E    FD   DF    E               ","              EE     D   D     EE              ","              EE     D   D     EE              ","              E      D   D      E              ","             EE      D   D      EE             ","             EE      D   D      EE             ","             E                   E             ","            EE                   EE            ","            EE                   EE            ","           EE                     EE           ","          EEE       XD   DX       EEE          ","         EEE        XD   DX        EEE         ","        EE          XD   DX          EE        ","F     FFF         FFFDDDDDFFF         FFF     F","A     AAAAAAAA    AAAXXXXXAAA    AAAAAAAA     A")
                    .aisle("                    FD   DF                    ","                    ED   DE                    ","                    ED   DE                    ","                    ED   DE                    ","                    ED   DE                    ","                    ED   DE                    ","                   F D   D F                   ","                     D   D                     ","                     D   D                     ","                     D   D                     ","                     D   D                     ","                     D   D                     ","                     D   D                     ","                     D   D                     ","                     D   D                     ","                     D   D                     ","                     D   D                     ","                     D B D                     ","                    FD - DF                    ","                     C - C                     ","                     C - C                     ","                     C - C                     ","                     C - C                     ","                     C - C                     ","                     C - C                     ","                     C - C                     ","                     C - C                     ","                     C - C                     ","                    FC - CF                    ","                     C - C                     ","                     C - C                     ","                     C - C                     ","                     C - C                     ","                     C - C                     ","                     C - C                     ","                     C - C                     ","                     C - C                     ","                     C - C                     "," VV           VV    XC - CX    VV           VV "," VI           VI    XC - CX    IV           IV "," VV           VV    XC - CX    VV           VV ","FVVFFFF       VVFFFFFDDDDDFFFFFVV       FFFFVVF","AVV   AAAAAAAAVV  AAAXXXXXAAA  VVAAAAAAAA   VVA")
                    .aisle("                    F     F                    ","                                               ","                                               ","                                               ","                                               ","                                               ","                   F       F                   ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                 EE         EE                 ","                 EE         EE                 ","                 E           E                 ","                 E           E                 ","                 E  F     F  E                 ","                 E           E                 ","                 E           E                 ","                 E           E                 ","                EE           EE                ","                EE           EE                ","                E             E                ","                E             E                ","               EE             EE               ","               EE             EE               ","               E    FD   DF    E               ","              EE     D   D     EE              ","              EE     D   D     EE              ","              E      D   D      E              ","             EE      D   D      EE             ","             EE      D   D      EE             ","             E                   E             ","            EE                   EE            ","            EE                   EE            ","           EE                     EE           ","          EEE       XD   DX       EEE          ","         EEE        XD   DX        EEE         ","        EE          XD   DX          EE        ","F     FFF         FFFDDDDDFFF         FFF     F","A     AAAAAAAA    AAAXXXXXAAA    AAAAAAAA     A")
                    .aisle("                     F D F                     ","                       D                       ","                       D                       ","                       D                       ","                       D                       ","                       D                       ","                    F  D  F                    ","                       D                       ","                  D    D    D                  ","                  D    D    D                  ","                  D    D    D                  ","                  D    D    D                  ","                  D    D    D                  ","                  D    D    D                  ","                  D    D    D                  ","                 DD    D    DD                 ","                 D     D     D                 ","                 D     D     D                 ","                 D   F D F   D                 ","                 D     C     D                 ","                 D     C     D                 ","                 D     C     D                 ","                 D     C     D                 ","                DD     C     DD                ","                D      C      D                ","                D      C      D                ","                D      C      D                ","               DD      C      DD               ","               D     FDCDF     D               ","               D      DCD      D               ","              DD      DCD      DD              ","              D       DCD       D              ","              D       DCD       D              ","             DD      DDCDD      DD             ","             D       D C D       D             ","             D       D C D       D             ","            DD       D C D       DD            ","            D        D C D        D            "," VV        DD VV     XDCDX     VV DD        VV "," VI       DD  VI     XDCDX     IV  DD       IV "," VV    DDDD   VV     XDCDX     VV   DDDD    VV ","FVVFFFFFFD    VVFFFFFDDDDDFFFFFVV    DFFFFFFVVF","AVVAAAAAAAAAAAVV  AAAXXXXXAAA  VVAAAAAAAAAAAVVA")
                    .aisle("                      FFF                      ","                       E                       ","                       E                       ","                       E                       ","                       E                       ","                       E                       ","                     F   F                     ","                    E     E                    ","                    E     E                    ","                    E     E                    ","                    E     E                    ","                    E     E                    ","                    E     E                    ","                    E     E                    ","                    E     E                    ","                    E     E                    ","                                               ","                                               ","                      FFF                      ","                                               ","                                               ","                  H         H                  ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      FFF                      ","                                               ","                                               ","                                               ","                                               ","             H                   H             ","                                               ","                                               ","                                               ","                                               ","                      XXX                      ","                      XXX                      ","        D             XXX             D        ","FFFFFFFFFF        FFFFFFFFFFF        FFFFFFFFFF","AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      FFF                      ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                   E       E                   ","                   E       E                   ","                   E       E                   ","                   E       E                   ","                   E       E                   ","                   E       E                   ","                   E       E                   ","                  HE       EH                  ","                   E       E                   ","                   E       E                   ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","              H                 H              ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","        D                             D        "," FFFFFFFFF         FFFFFFFFF         FFFFFFFFF "," AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                                               ","                                               ","                                               ","                                               ","                                               ","                   HH     HH                   ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                  E         E                  ","                                               ","                                               ","                                               ","                                               ","                                               ","              H                 H              ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","        D                             D        ","    FFFFFF          FFFFFFF          FFFFFF    "," AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                                               ","                                               ","                 E           E                 ","                 E           E                 ","                 E           E                 ","                 E           E                 ","                 E           E                 ","                                               ","                                               ","               H               H               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","         D                           D         ","        FFF          F F F          FFF        "," AAAAAAAAAAAAAAAAAAAA     AAAAAAAAAAAAAAAAAAAA ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                E             E                ","                E             E                ","                E             E                ","                E             E                ","                E             E                ","               HE             EH               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","         D                           D         ","        FFF          F F F          FFF        ","  AA  AAAAAAAAAAAAAAA     AAAAAAAAAAAAAAA  AA  ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                                               ","               E               E               ","               EHH           HHE               ","               E               E               ","               E               E               ","               E               E               ","               E               E               ","               E     V V V     E               ","               E     I I I     E               ","               E     V V V     E               ","         FF    E     V V V     E    FF         ","  AA     AAAAAAAAAAAAV V VAAAAAAAAAAAA     AA  ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                  HH DE ED HH                  ","                                               ","                                               ","                                               ","                                               ","                     V V V                     ","                     V V V                     ","                     V V V                     ","                     V V V                     ","  AA     AAAAAAAAAAAAV V VAAAAAAAAAAAA     AA  ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                    HDE EDH                    ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                                               ","                                               ","                                               ","                                               ","                                               ","   AA     AAAAAAAAAAAAAAAAAAAAAAAAAAA     AA   ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     DE ED                     ","                     DE ED                     ","                                               ","                                               ","                                               ","   AA      AAAAAAAAAAAAAAAAAAAAAAAAA      AA   ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     DE ED                     ","                                               ","                                               ","    AA      AAAAAAAAAAAAAAAAAAAAAAA      AA    ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                     DE ED                     ","                     D   D                     ","               FFF           FFF               ","    AA       AAAAAAAAAAAAAAAAAAAAA       AA    ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                      E E                      ","                DD   DE ED   DD                ","               FFFFFFD   DFFFFFF               ","     AA       AAAAAAAAAAAAAAAAAAA       AA     ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                  DDDDE EDDDD                  ","                FFFFFFF FFFFFFF                ","     AAA        AAAAAAAAAAAAAAA        AAA     ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                     D   D                     ","                  FFFFF FFFFF                  ","      AAA       AAAAAAAAAAAAAAA       AAA      ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                  FFFFFFFFFFF                  ","       AAA      AAAAAAAAAAAAAAA      AAA       ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                  FFFF F FFFF                  ","        AAAA     AAAAA   AAAAA     AAAA        ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                  FFFF F FFFF                  ","          AAAA   AAAAA   AAAAA   AAAA          ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                   FFF F FFF                   ","            AAAAAAAAAA   AAAAAAAAAA            ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                     V V V                     ","                     I I I                     ","                     V V V                     ","                   FFV V VFF                   ","              AAAAAAAV V VAAAAAAA              ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                     V V V                     ","                     V V V                     ","                     V V V                     ","                   FFV V VFF                   ","                 AAAAV V VAAAA                 ")
                    .aisle("                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                                               ","                    FFFFFFF                    ","                    AAAAAAA                    ")
                    .where('~', selfPredicate())
                    .where('D', states(getCasingState()))
                    .where('F', states(getSecondCasingState()))
                    .where('E', states(getThirdCasingState()))
                    .where('A', states(getFourthCasingState()))
                    .where('H', frames(Neutronium))
                    .where('X', states(getCasingState())
                            .or(abilities(MultiblockAbility.INPUT_ENERGY)
                                    .setMaxGlobalLimited(2)
                                    .setPreviewCount(1))
                            .or(abilities(MultiblockAbility.INPUT_LASER)
                                    .setMaxGlobalLimited(1)
                                    .setPreviewCount(0))
                            .or(abilities(MultiblockAbility.COMPUTATION_DATA_RECEPTION)
                                    .setMaxGlobalLimited(1)
                                    .setPreviewCount(1)))
                    .where('V', states(getCasingState())
                            .or(abilities(MultiblockAbility.IMPORT_ITEMS, MultiblockAbility.IMPORT_FLUIDS,
                                    MultiblockAbility.EXPORT_ITEMS, MultiblockAbility.EXPORT_FLUIDS,
                                    MultiblockAbility.COMPUTATION_DATA_RECEPTION)
                                    .setPreviewCount(0)))
                    .where('C', accelerationOrbits())
                    .where('I', states(getCasingState())
                            .or(modulePredicate()))
                    .where(' ', any())
                    .where('-', air())
                    .where('B', air()) // TODO A renderer block (space elevator cable)?
                    .build();
        }
    }

    private static IBlockState getCasingState()
    {
        return GTLiteMetaBlocks.SPACE_ELEVATOR_CASING.getState(BlockSpaceElevatorCasing.CasingType.BASE_CASING);
    }

    private static IBlockState getSecondCasingState()
    {
        return GTLiteMetaBlocks.SPACE_ELEVATOR_CASING.getState(BlockSpaceElevatorCasing.CasingType.INTERNAL_STRUCTURE_CASING);
    }

    private static IBlockState getThirdCasingState()
    {
        return GTLiteMetaBlocks.SPACE_ELEVATOR_CASING.getState(BlockSpaceElevatorCasing.CasingType.SUPPORT_STRUCTURE_CASING);
    }

    private static IBlockState getFourthCasingState()
    {
        return GTLiteMetaBlocks.SPACE_ELEVATOR_CASING.getState(BlockSpaceElevatorCasing.CasingType.HIGH_STRENGTH_CONCRETE);
    }

    @ApiStatus.Internal
    @NotNull
    protected TraceabilityPredicate modulePredicate()
    {
        return new TraceabilityPredicate(blockWorldState -> {
            IBlockState state = blockWorldState.getBlockState();
            Block block = state.getBlock();
            // Common blocks.
            if (block instanceof BlockSpaceElevatorCasing)
            {
                BlockSpaceElevatorCasing.CasingType casingType = ((BlockSpaceElevatorCasing)
                        state.getBlock()).getState(state);
                if (casingType == BlockSpaceElevatorCasing.CasingType.BASE_CASING)
                    return true;
            }
            // Module mtes.
            TileEntity te = blockWorldState.getTileEntity();
            if (!(te instanceof IGregTechTileEntity))
                return false;

            MetaTileEntity mte = ((IGregTechTileEntity) te).getMetaTileEntity();
            if (mte instanceof IModuleProvider)
                return false;
            if (!(mte instanceof IModuleReceiver))
                return false;

            IModuleReceiver moduleReceiver = (IModuleReceiver) mte;
            if (moduleReceiver.getModuleProvider() != this)
            {
                moduleReceiver.setModuleProvider(this);
                moduleReceivers.add(moduleReceiver);
            }
            return true;
        });
    }

    @SideOnly(Side.CLIENT)
    @Override
    public ICubeRenderer getBaseTexture(IMultiblockPart sourcePart)
    {
        return GTLiteTextures.SPACE_ELEVATOR_BASE_CASING;
    }

    @SideOnly(Side.CLIENT)
    @NotNull
    @Override
    protected ICubeRenderer getFrontOverlay()
    {
        return GTLiteTextures.SPACE_ELEVATOR_OVERLAY;
    }

    @Override
    public void renderMetaTileEntity(CCRenderState renderState,
                                     Matrix4 translation,
                                     IVertexOperation[] pipeline)
    {
        super.renderMetaTileEntity(renderState, translation, pipeline);
        getFrontOverlay().renderOrientedState(renderState, translation, pipeline,
                getFrontFacing(), true, true);
    }

    @Override
    public boolean hasMaintenanceMechanics()
    {
        return false;
    }

    @Override
    public NBTTagCompound writeToNBT(NBTTagCompound data)
    {
        data.setBoolean("extended", isExtended);
        return super.writeToNBT(data);
    }

    @Override
    public void readFromNBT(NBTTagCompound data)
    {
        super.readFromNBT(data);
        this.isExtended = data.getBoolean("extended");
    }

    @Override
    public void writeInitialSyncData(PacketBuffer buf)
    {
        super.writeInitialSyncData(buf);
        buf.writeBoolean(this.isExtended);
    }

    @Override
    public void receiveInitialSyncData(PacketBuffer buf)
    {
        super.receiveInitialSyncData(buf);
        this.isExtended = buf.readBoolean();
    }

    @NotNull
    @Override
    protected Widget getFlexButton(int x, int y, int width, int height)
    {
        return new ImageCycleButtonWidget(173, 125, 18, 18,
                GTLiteGuiTextures.BUTTON_ELEVATOR_EXTENSION, this::isExtended, this::setExtended)
                .setTooltipHoverString("gtlitecore.machine.space_elevator.extension_info");
    }

    private boolean checkModules()
    {
        return getModuleCount() <= getMaxModules();
    }

    private int getModuleCount()
    {
        return moduleReceivers.size();
    }

    private int getMaxModules()
    {
        if (orbitTier == 1)
            return 6;
        if (orbitTier == 2)
            return 12;
        if (orbitTier == 3 && isExtended)
            return 15;
        if (orbitTier == 4 && isExtended)
            return 18;
        if (orbitTier == 5 && isExtended)
            return 24;
        return 12;
    }

    protected boolean isExtended()
    {
        return this.isExtended;
    }

    protected void setExtended(boolean extended)
    {
        this.isExtended = extended;
        invalidateStructure();
        reinitializeStructurePattern();
    }

    @Override
    public int getCasingTier()
    {
        return orbitTier;
    }

    @Override
    public IEnergyContainer getSubEnergyContainer()
    {
        return energyContainer;
    }

    @Override
    public boolean isModule(IModuleReceiver receiver)
    {
        return moduleReceivers.contains(receiver);
    }

}
